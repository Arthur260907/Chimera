<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Page</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/Header.css">
    <link rel="stylesheet" href="../css/perfil.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
        <div id="logo-separator">
            <img id="logo" src="../Imagens/image0_large.png" alt="Logo">
        </div>

        <span class="header_icon" id="filter-home"><a href="../index.html">
                <h5>Home</h5>
            </a></span>
        <span class="header_icon" id="filter-movies">
            <h5>Movies</h5>
        </span>
        <span class="header_icon" id="filter-series">
            <h5>Series</h5>
        </span>

        <div id="top-corner">

            <form id="search-form" action="pesquisa.html" method="GET">
                <input type="text" id="search-input" name="q" placeholder="Search...">
                <button type="submit" id="search-btn"></button>
            </form>

            <div id="search-suggestions" class="suggestions-dropdown"></div>

            <div class="profile-container">


                <div class="profile-icon">
                    <img src="../Imagens/image 8.png" alt="Profile">
                </div>

                <div class="dropdown-menu">
                    <div class="menu-content">
                        <div class="section section-account">
                            <h3>Account</h3>
                            <ul>
                                <li class="active-item"><a id="signin-link" href="Login.html">Sign in</a></li>
                                <li><a id="signout-link" href="#">Sign out</a></li>
                            </ul>
                        </div>
                        <div class="section section-profiles">
                            <h3>PROFILES</h3>
                            <ul>
                                <li>
                                    <a href="perfil.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                        <img src="../imagens/image 8.png" alt="Avatar" style="margin-right: 10px;">
                                        <span id="profile-username">User</span>
                                    </a>
                                </li>
                            </ul>
                            <div class="profile-actions">
                                <div id="flex-more">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <span class="header_icon">
            <img src="../Imagens/bell-svgrepo-com 1.png" alt="Notifications">
        </span>
    </header>

    <main class="profile-main">
        <div class="profile-container">
            <div class="profile-header">
                <img src="../Imagens/image 8.png" alt="Profile Picture" class="profile-pic">
                <div class="profile-info">
                    <h1 id="profile-name">Gabriel</h1>
                    <p id="profile-email">gabriel@example.com</p>
                </div>
            </div>

            <div class="profile-sections">
                <section class="profile-section">
                    <h2>Account Settings</h2>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <h3>Change Password</h3>
                            <p>Update your password to keep your account secure.</p>
                            <button class="btn">Change Password</button>
                        </div>
                        <div class="setting-item">
                            <h3>Delete Account</h3>
                            <p>Permanently delete your account.</p>
                            <button class="btn btn-danger">Delete Account</button>
                        </div>
                    </div>
                </section>

                <section class="profile-section">
                    <h2>Favorites</h2>
                    <div class="multi-carousel-container">
                        <div class="carousel-list" id="favorites-carousel">
                            <!-- Favorites will be loaded here -->
                        </div>
                        <button class="multi-carousel-btn prev" id="prev-btn"><</button>
                        <button class="multi-carousel-btn next" id="next-btn">></button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-links">
            <ul>
                <li><a href="#">Audio description</a></li>
                <li><a href="#">Investor relations</a></li>
                <li><a href="#">Legal notices</a></li>
            </ul>
            <ul>
                <li><a href="#">Help center</a></li>
                <li><a href="#">Careers</a></li>
                <li><a href="#">Cookie preferences</a></li>
            </ul>
            <ul>
                <li><a href="#">Gift card</a></li>
                <li><a href="#">Terms of use</a></li>
                <li><a href="#">Corporate information</a></li>
            </ul>
            <ul>
                <li><a href="#">Press</a></li>
                <li><a href="#">Privacy</a></li>
                <li><a href="#">Contact us</a></li>
            </ul>
        </div>
        <div class="footer-copy">
            © 2025 Chimera, Inc.
        </div>
    </footer>

    <script> const API_BASE_URL = 'http://localhost:5012'; // AJUSTE A PORTA SE NECESSÁRIO! </script>
    <script src="../js/script.js"></script>
    <script src="../js/header.js"></script>

    <script>
        // Update header based on login state
        function updateHeaderLoginState() {
            const userData = localStorage.getItem('chimeraUser');
            const signinLink = document.getElementById('signin-link');
            const signoutLink = document.getElementById('signout-link');
            const profileUsername = document.getElementById('profile-username');

            if (userData) {
                const user = JSON.parse(userData);
                if (user.token) {
                    // User is logged in
                    if (signinLink) signinLink.style.display = 'none';
                    if (signoutLink) signoutLink.style.display = 'block';
                    if (profileUsername) profileUsername.textContent = user.name || 'User';
                    return;
                }
            }

            // User is not logged in
            if (signinLink) signinLink.style.display = 'block';
            if (signoutLink) signoutLink.style.display = 'none';
            if (profileUsername) profileUsername.textContent = 'User'; // Default
        }

        // Handle sign out
        function setupSignOut() {
            const signoutLink = document.getElementById('signout-link');
            if (signoutLink) {
                signoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('chimeraUser');
                    window.location.href = '../index.html';
                });
            }
        }

        // Código do menu de perfil
        const profileIcon = document.querySelector('.profile-icon');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        profileIcon.addEventListener('click', function (event) {
            event.stopPropagation();
            dropdownMenu.classList.toggle('active');
        });

        document.addEventListener('click', function (event) {
            if (!dropdownMenu.contains(event.target) && !profileIcon.contains(event.target)) {
                if (dropdownMenu.classList.contains('active')) {
                    dropdownMenu.classList.remove('active');
                }
            }
        });

        // Load user profile data
        async function loadProfile() {
            const userData = localStorage.getItem('chimeraUser');
            if (!userData) {
                window.location.href = 'Login.html';
                return;
            }

            const user = JSON.parse(userData);
            const token = user.token;
            if (!token) {
                localStorage.removeItem('chimeraUser');
                window.location.href = 'Login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const profileData = await response.json();
                    document.getElementById('profile-name').textContent = profileData.name;
                    document.getElementById('profile-email').textContent = profileData.email;
                    document.getElementById('profile-username').textContent = profileData.name;
                    // Update localStorage with latest name
                    user.name = profileData.name;
                    localStorage.setItem('chimeraUser', JSON.stringify(user));
                } else {
                    // Don't remove token on profile fetch failure - just show error
                    console.error('Failed to load profile data');
                    // Keep user logged in, just show default data
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                // Don't log out user on network error - keep them logged in
            }
        }

        // Load favorites carousel
        async function loadFavorites() {
            const userData = localStorage.getItem('chimeraUser');
            if (!userData) return;

            const user = JSON.parse(userData);
            const token = user.token;
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/favorites`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const favorites = await response.json();
                    const carousel = document.getElementById('favorites-carousel');
                    carousel.innerHTML = '';

                    favorites.forEach(fav => {
                        const item = document.createElement('div');
                        item.className = 'carousel-item';
                        item.innerHTML = `
                            <img src="${fav.posterUrl || '../imagens/image_placeholder.png'}" alt="${fav.title}" class="card-banner">
                            <div class="title-wrapper">
                                <h3 class="card-title">${fav.title}</h3>
                            </div>
                        `;
                        item.addEventListener('click', () => {
                            window.location.href = `filmeSerie.html?id=${fav.imdbId}`;
                        });
                        carousel.appendChild(item);
                    });

                    // Update carousel navigation after loading items
                    updateCarouselButtons();
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        // Update carousel navigation buttons based on items count
        function updateCarouselButtons() {
            const items = document.querySelectorAll('.carousel-item');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            if (items.length <= 4) {
                // Hide buttons if there are 4 or fewer items
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                // Show buttons if there are more than 4 items
                if (prevBtn) prevBtn.style.display = 'block';
                if (nextBtn) nextBtn.style.display = 'block';
            }
        }

        // Carousel navigation
        let currentIndex = 0;
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const carouselList = document.querySelector('.carousel-list');
        const items = document.querySelectorAll('.carousel-item');

        function updateCarousel() {
            const itemWidth = items[0]?.offsetWidth + 16; // 16px gap
            carouselList.style.transform = `translateX(-${currentIndex * itemWidth}px)`;
        }

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < items.length - 4) { // Show 4 items at a time
                currentIndex++;
                updateCarousel();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateHeaderLoginState();
            setupSignOut();
            loadProfile();
            loadFavorites();
        });
    </script>

</body>

</html>
