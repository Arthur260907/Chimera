<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In</title>
    <link rel="stylesheet" href="../css/login.css">
    <link rel="stylesheet" href="../css/Header.css">
    </head>
<body>
 <header>
    <div id="logo-separator">
        <img id="logo" src="../Imagens/image0_large.png" alt="Logo">
    </div>
    <span class="header_icon" id="filter-home"><a href="../index.html"><h5>Home</h5></a></span>
    <span class="header_icon" id="filter-movies"><h5>Movies</h5></span>
    <span class="header_icon" id="filter-series"><h5>Series</h5></span>
    <div id="top-corner">
        <form id="search-form" action="pesquisa.html" method="GET">
            <input type="text" id="search-input" name="q" placeholder="Search...">
            <button type="submit" id="search-btn"></button>
        </form>
        <div id="search-suggestions" class="suggestions-dropdown"></div>
        <div class="profile-container">
            <div class="profile-icon">
                <img src="../Imagens/image 8.png" alt="Profile">
            </div>
           <div class="dropdown-menu">
                <div class="menu-content">
                    <div class="section section-account">
                        <h3>Account</h3>
                        <ul>
                            <li class="active-item"><a id="signin-link" href="Login.html">Sign in</a></li>
                            <li><a id="signout-link" href="#">Sign out</a></li>
                        </ul>
                    </div>
                    <div class="section section-profiles">
                        <h3>PROFILES</h3>
                        <ul>
                            <li>
                                <a href="perfil.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                    <img src="../imagens/image 8.png" alt="Avatar" style="margin-right: 10px;">
                                    <span id="profile-username">Visitor</span>
                                </a>
                            </li>
                        </ul>
                        <div class="profile-actions">
                            <div id="flex-more"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <span class="header_icon">
        <img src="../Imagens/bell-svgrepo-com 1.png" alt="Notifications">
    </span>
</header>

    <main id="container">
        <form class="login-form" id="login-form"> 
            <h2>Sign In</h2>
            <div class="input-group">
                <input type="email" id="email" name="email" class="input-field" placeholder=" " required>
                <label for="email" class="input-label">Email</label>
            </div>
            <div class="input-group">
                <input type="password" id="password" name="password" class="input-field" placeholder=" " required>
                <label for="password" class="input-label">Password</label>
            </div>
            <div class="forgot-password-link">
                <a href="recuperar_senha.html">Forgot password</a>
            </div>
            <div class="button-group">
                <button type="submit" class="btn-submit">Sign In</button>
            </div>
             <p id="login-error" style="color:red; margin-top: 1em; height: 1em;"></p>
            <div class="register-link">
                 <p>Don't have an account? <a href="cadastro.html">Sign up now</a></p>
            </div>
        </form>
    </main> 

    <script src="../js/header.js"></script>
    <script src="../js/script.js"></script> 
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form'); 
            const emailInput = document.getElementById('email'); 
            const passwordInput = document.getElementById('password'); // Corrigido de 'senha' para 'password'
            const errorMessageElement = document.getElementById('login-error'); 

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); 
                    if (errorMessageElement) errorMessageElement.textContent = ''; 

                    const email = emailInput.value.trim();
                    const password = passwordInput.value; // Não usar trim()

                    if (!email || !password) {
                         if (errorMessageElement) errorMessageElement.textContent = 'Please fill in email and password.';
                        return;
                    }

                    try {
                        // API_BASE_URL vem do header.js
                        const response = await fetch(`${API_BASE_URL}/api/Usuarios/login`, { // Endpoint correto
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', },
                            // O backend espera Email e Senha (PascalCase)
                            body: JSON.stringify({ Email: email, Senha: password }), 
                        });

                        if (response.ok) {
                            const userData = await response.json(); // Espera { username: "..." }
                            if (userData && userData.username) {
                                saveLoginData(userData); // Salva no localStorage (função do header.js)
                                window.location.href = '../index.html'; // Redireciona para a home
                            } else {
                                throw new Error("Invalid login response received from API.");
                            }
                        } else {
                            let errorMsg = 'Login failed. Check your credentials.';
                            try { const errorData = await response.json(); if(errorData && errorData.message) { errorMsg = errorData.message; } else if (response.status === 401) { errorMsg = 'Invalid email or password.'; } } catch(jsonError) { errorMsg = `Login failed (Status: ${response.status})`; }
                             if (errorMessageElement) errorMessageElement.textContent = errorMsg;
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                         if (errorMessageElement) errorMessageElement.textContent = 'Connection error. Please try again later.';
                    }
                });
            } else { console.error("Login form (#login-form) not found."); }
        });
    </script>
</body>
</html>