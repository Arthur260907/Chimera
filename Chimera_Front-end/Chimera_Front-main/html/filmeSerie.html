<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie/Series Details</title>
    <link rel="stylesheet" href="../css/filmeSerie.css">
    <link rel="stylesheet" href="../css/Header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <header>
        <div id="logo-separator">
            <img id="logo" src="../Imagens/image0_large.png" alt="Logo">
        </div>
        <span class="header_icon" id="filter-home"><a href="../index.html">
                <h5>Home</h5>
            </a></span>
        <span class="header_icon" id="filter-movies">
            <h5>Movies</h5>
        </span>
        <span class="header_icon" id="filter-series">
            <h5>Series</h5>
        </span>
        <div id="top-corner">
            <form id="search-form" action="/Chimera_Front-end/Chimera_Front-main/html/pesquisa.html" method="GET">
                <input type="text" id="search-input" name="q" placeholder="Search...">
                <button type="submit" id="search-btn"></button>
            </form>
            <div id="search-suggestions" class="suggestions-dropdown"></div>
            <div class="profile-container">
                <div class="profile-icon">
                    <img src="../Imagens/image 8.png" alt="Profile">
                </div>
                <div class="dropdown-menu">
                    <div class="menu-content">
                        <div class="section section-account">
                            <h3>Account</h3>
                            <ul>
                                <li class="active-item"><a id="signin-link"
                                        href="/Chimera_Front-end/Chimera_Front-main/html/Login.html">Sign in</a></li>
                                <li><a id="signout-link" href="#">Sign out</a></li>
                            </ul>
                        </div>
                        <div class="section section-profiles">
                            <h3>PROFILES</h3>
                            <ul>
                                <li>
                                    <a href="perfil.html" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                                        <img src="../imagens/image 8.png" alt="Avatar" style="margin-right: 10px;">
                                        <span id="profile-username">User</span>
                                    </a>
                                </li>
                            </ul>
                            <div class="profile-actions">
                                <div id="flex-more"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <span class="header_icon">
            <img src="../Imagens/bell-svgrepo-com 1.png" alt="Notifications">
        </span>
    </header>

    <div class="container" id="movie-details-container">
        <div class="left-column">
            <img id="movie-poster" src="../imagens/image_placeholder.png" alt="Poster Loading..."
                style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; margin-bottom: 1em; background-color: #111;">

            <div class="action-icons">
                <i class="fa-solid fa-heart action-icon" id="favorite-btn" title="Add to Favorites"></i>
                <i class="fa-solid fa-thumbs-up action-icon" id="like-btn" title="Like"></i>
                <i class="fa-solid fa-thumbs-down action-icon" id="dislike-btn" title="Dislike"></i>
                <i class="fa-solid fa-share-nodes action-icon" id="share-btn" title="Share"></i>
            </div>
            <div class="synopsis">
                <h2 id="movie-title">Loading title...</h2>
                <p><strong>Year:</strong> <span id="movie-year">N/A</span></p>
                <p><strong>Director:</strong> <span id="movie-director">N/A</span></p>
                <h3>Synopsis</h3>
                <p id="movie-plot">Loading plot...</p>
                <p><strong>Genre:</strong> <span id="movie-genre">N/A</span></p>
                <p><strong>Actors:</strong> <span id="movie-actors">N/A</span></p>
                <p><strong>Runtime:</strong> <span id="movie-runtime">N/A</span></p>
            </div>
        </div>

        <div class="right-column">
            <div class="video-player">
                <p><i>Trailer:</i></p>
                <iframe width="560" height="315" src="" title="YouTube video player" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen style="display: none; background-color: #000;"> </iframe>
            </div>

            <div class="related-search">
                <form>
                    <input type="text" name="comment" placeholder="Escreva seu comentário aqui..." required>
                    <button type="button" aria-label="Comentar">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>

            <div class="reviews-container">
                <div class="user-reviews">
                    <h3>Reviews (Static Example)</h3>
                    <p style="font-size: 14px; color: #aaa;"><i>User reviews coming soon.</i></p>
                </div>
                <div class="ratings">
                    <h3>Ratings</h3>
                    <p style="font-size: 14px; color: #aaa;"><i>Loading ratings...</i></p>
                </div>
            </div>
        </div>
    </div>

    <p id="details-status" style="text-align: center; margin-top: 20px;"></p>

    <script> const API_BASE_URL = 'http://localhost:5012'; // AJUSTE A PORTA SE NECESSÁRIO! </script>
    <script src="../js/script.js"></script>
    <script src="../js/header.js"></script>
    <script src="../js/comment.js"></script>
    <script>
        // Update header based on login state
        function updateHeaderLoginState() {
            const userData = localStorage.getItem('chimeraUser');
            const signinLink = document.getElementById('signin-link');
            const signoutLink = document.getElementById('signout-link');
            const profileUsername = document.getElementById('profile-username');

            if (userData) {
                const user = JSON.parse(userData);
                if (user.token) {
                    // User is logged in
                    if (signinLink) signinLink.style.display = 'none';
                    if (signoutLink) signoutLink.style.display = 'block';
                    if (profileUsername) profileUsername.textContent = user.name || 'User';
                    return;
                }
            }

            // User is not logged in
            if (signinLink) signinLink.style.display = 'block';
            if (signoutLink) signoutLink.style.display = 'none';
            if (profileUsername) profileUsername.textContent = 'User'; // Default
        }

        // Handle sign out
        function setupSignOut() {
            const signoutLink = document.getElementById('signout-link');
            if (signoutLink) {
                signoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('chimeraUser');
                    window.location.href = '../index.html';
                });
            }
        }

        // Load user profile data for header
        async function loadUserProfile() {
            const userData = localStorage.getItem('chimeraUser');
            if (!userData) return;

            const user = JSON.parse(userData);
            const token = user.token;
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const profileData = await response.json();
                    document.getElementById('profile-username').textContent = profileData.name;
                    // Update localStorage with latest name
                    user.name = profileData.name;
                    localStorage.setItem('chimeraUser', JSON.stringify(user));
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // --- CÓDIGO JAVASCRIPT CORRIGIDO (ENDPOINT E camelCase) ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateHeaderLoginState();
            setupSignOut();
            loadUserProfile();
            const urlParams = new URLSearchParams(window.location.search);
            const imdbId = urlParams.get('id');
            const detailsContainer = document.getElementById('movie-details-container');
            const statusElement = document.getElementById('details-status');

            if (!imdbId) {
                if (detailsContainer) detailsContainer.innerHTML = "<h2>ID do filme/série não fornecido.</h2>";
                if (statusElement) statusElement.textContent = "Erro: ID não encontrado na URL.";
                return;
            }
            if (statusElement) statusElement.textContent = "Carregando detalhes...";

            try {
                // Endpoint correto que retorna o DTO
                const response = await fetch(`${API_BASE_URL}/api/movies/byId/${imdbId}`); // Usa 'byId'

                if (!response.ok) {
                    let errorMsg = `Falha ao buscar detalhes (Status: ${response.status})`;
                    try {
                        const errorData = await response.json();
                        if (errorData) errorMsg = errorData.title || errorData.detail || errorData.message || JSON.stringify(errorData);
                    } catch (e) { /* Ignora */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json(); // 'data' é o MovieDetailDto em JSON (camelCase)

                // Verifica 'title' (camelCase)
                if (data && data.title) {
                    if (statusElement) statusElement.textContent = "";
                    populateMovieDetails(data);
                    document.title = data.title || "Details";
                    initializeActionIcons(); // Initialize action icons after loading movie details
                } else {
                    throw new Error(data?.error || "Dados recebidos inválidos ou filme não encontrado.");
                }
            } catch (error) {
                console.error('Erro ao buscar ou processar detalhes:', error);
                if (detailsContainer) detailsContainer.innerHTML = `<h2>Erro ao carregar detalhes.</h2><p>${error.message || error}</p>`;
                if (statusElement) statusElement.textContent = "Erro.";
            }
        });

        // --- FUNÇÃO populateMovieDetails CORRIGIDA (usa camelCase) ---
        function populateMovieDetails(data) {
            console.log("Dados recebidos (DTO JSON):", data);

            if (!data || typeof data !== 'object') {
                console.error("populateMovieDetails recebeu dados inválidos:", data);
                // Tratamento de erro...
                return;
            }

            // Seleciona elementos
            const titleElement = document.getElementById('movie-title');
            const yearElement = document.getElementById('movie-year');
            const posterElement = document.getElementById('movie-poster');
            const plotElement = document.getElementById('movie-plot');
            const directorElement = document.getElementById('movie-director');
            const genreElement = document.getElementById('movie-genre');
            const actorsElement = document.getElementById('movie-actors');
            const runtimeElement = document.getElementById('movie-runtime');
            const trailerFrame = document.querySelector('.video-player iframe');
            const trailerPlaceholder = document.querySelector('.video-player p');

            // Populando Ratings (Usa camelCase: imdbRating, ratings, source, value)
            const ratingsContainer = document.querySelector('.ratings');
            if (ratingsContainer) {
                ratingsContainer.innerHTML = '<h3>Ratings</h3>';
                let hasRatings = false;
                // IMDb
                if (data.imdbRating && data.imdbRating !== 'N/A') {
                    const imdbDiv = document.createElement('div');
                    imdbDiv.className = 'rating-item';
                    imdbDiv.innerHTML = `<h4>IMDb</h4><p>${data.imdbRating}</p>`;
                    ratingsContainer.appendChild(imdbDiv);
                    hasRatings = true;
                }
                // Lista de Ratings
                if (data.ratings && Array.isArray(data.ratings) && data.ratings.length > 0) {
                    data.ratings.forEach(rating => {
                        if (rating && typeof rating === 'object') {
                            const ratingDiv = document.createElement('div');
                            ratingDiv.className = 'rating-item';
                            let sourceName = rating.source; // Usa 'source'
                            if (sourceName && typeof sourceName === 'string') {
                                if (sourceName.toLowerCase().includes('rotten tomatoes')) sourceName = 'Rotten Tomatoes';
                                else if (sourceName.toLowerCase().includes('metacritic')) sourceName = 'Metacritic';
                                else if (sourceName.toLowerCase().includes('internet movie database')) sourceName = null;
                            } else { sourceName = null; }

                            if (sourceName) {
                                ratingDiv.innerHTML = `<h4>${sourceName}</h4><p>${rating.value || 'N/A'}</p>`; // Usa 'value'
                                ratingsContainer.appendChild(ratingDiv);
                                hasRatings = true;
                            }
                        }
                    });
                }
                if (!hasRatings) {
                    ratingsContainer.innerHTML += '<p style="font-size: 14px; color: #aaa;"><i>Ratings not available.</i></p>';
                }
            } else {
                console.error("Container '.ratings' não encontrado.");
            }

            // Atualiza Pôster (Usa camelCase: bestPosterUrl, originalPosterUrl)
            if (posterElement) {
                const posterSrc = data.bestPosterUrl || data.originalPosterUrl || '../imagens/image_placeholder.png';
                posterElement.src = posterSrc;
                posterElement.alt = data.title || 'Poster'; // Usa 'title'
            }

            // Atualiza Trailer (Usa camelCase: trailerUrl)
            if (trailerFrame && trailerPlaceholder) {
                if (data.trailerUrl) {
                    trailerFrame.src = data.trailerUrl;
                    trailerFrame.style.display = 'block';
                    trailerPlaceholder.style.display = 'none';
                } else {
                    trailerFrame.style.display = 'none';
                    trailerPlaceholder.style.display = 'block';
                    trailerPlaceholder.innerHTML = '<i>Trailer not available.</i>';
                }
            }

            // Atualiza o resto (Usa camelCase)
            if (titleElement) titleElement.textContent = data.title || 'Título não disponível';
            if (yearElement) yearElement.textContent = data.year || 'N/A';
            if (plotElement) plotElement.textContent = data.plot || 'Sinopse não disponível.';
            if (directorElement) directorElement.textContent = data.director || 'N/A';
            if (genreElement) genreElement.textContent = data.genre || 'N/A';
            if (actorsElement) actorsElement.textContent = data.actors || 'N/A';
            if (runtimeElement) runtimeElement.textContent = data.runtime || 'N/A';

            // Initialize favorite button
            initializeFavoriteButton(data.imdbId, data.title, data.bestPosterUrl || data.originalPosterUrl);
        }

        // Favorite functionality
        async function initializeFavoriteButton(imdbId, title, posterUrl) {
            const favoriteBtn = document.getElementById('favorite-btn');
            if (!favoriteBtn) return;

            const userData = localStorage.getItem('chimeraUser');
            if (!userData) {
                favoriteBtn.style.color = '#f0f0f0';
                favoriteBtn.title = 'Login to favorite';
                return;
            }

            const user = JSON.parse(userData);
            const token = user.token;
            if (!token) {
                favoriteBtn.style.color = '#f0f0f0';
                favoriteBtn.title = 'Login to favorite';
                return;
            }

            // Check if already favorited
            try {
                const response = await fetch(`${API_BASE_URL}/api/favorites`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const favorites = await response.json();
                    const isFavorited = favorites.some(fav => fav.imdbId === imdbId);
                    updateFavoriteButton(isFavorited);
                }
            } catch (error) {
                console.error('Error checking favorites:', error);
            }

            favoriteBtn.addEventListener('click', async () => {
                try {
                    const isFavorited = favoriteBtn.classList.contains('favorited');
                    const method = isFavorited ? 'DELETE' : 'POST';
                    const url = isFavorited
                        ? `${API_BASE_URL}/api/favorites/${imdbId}`
                        : `${API_BASE_URL}/api/favorites`;

                    const body = isFavorited ? null : JSON.stringify({
                        imdbId: imdbId,
                        title: title,
                        posterUrl: posterUrl
                    });

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: body
                    });

                    if (response.ok) {
                        updateFavoriteButton(!isFavorited);
                    } else {
                        console.error('Failed to toggle favorite');
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                }
            });
        }

        function updateFavoriteButton(isFavorited) {
            const favoriteBtn = document.getElementById('favorite-btn');
            if (isFavorited) {
                favoriteBtn.classList.add('favorited');
                favoriteBtn.style.color = '#e74c3c';
            } else {
                favoriteBtn.classList.remove('favorited');
                favoriteBtn.style.color = '#fff';
            }
        }

        // Initialize action icons with click effects
        function initializeActionIcons() {
            const actionIcons = document.querySelectorAll('.action-icon');

            actionIcons.forEach(icon => {
                icon.style.opacity = '1'; // Maximum opacity

                icon.addEventListener('click', () => {
                    // Temporarily reduce opacity
                    icon.style.opacity = '0.5';

                    // Reset opacity after a short delay
                    setTimeout(() => {
                        icon.style.opacity = '1';
                    }, 200);
                });
            });
        }

        // Call initialization after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing code ...
            // initializeActionIcons(); // Removed duplicate call
        });
    </script>
</body>

</html>