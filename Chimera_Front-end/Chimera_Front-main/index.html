<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/Header.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
    <div id="logo-separator">
        <img id="logo" src="Imagens/image0_large.png" alt="Logo">
    </div>

    <span class="header_icon"><a href="index.html"><h5>Home</h5></a></span>
    <span class="header_icon"><h5>Movies</h5></span>
    <span class="header_icon"><h5>Series</h5></span>

    <div id="top-corner">

        <form id="search-form" action="html/pesquisa.html" method="GET">
    
    <input type="text" id="search-input" name="q" placeholder="Search...">
    
    <button type="submit" id="search-btn">
        </button>
</form>

        <div class="profile-container">
            <div class="profile-icon">
                <img src="Imagens/image 8.png" alt="Profile">
            </div>

            <div class="dropdown-menu">
                <div class="menu-content">
                    <div class="section section-account">
                        <h3>Account</h3>
                        <ul>
                            <li class="active-item"><a href="html/Login.html">Sign in</a></li>
                            <li><a href="#">Sign out</a></li>
                        </ul>
                    </div>
                    <div class="section section-profiles">
                        <h3>PROFILES</h3>
                        <ul>
                            <li>
                                <img src="imagens/image 8.png" alt="Avatar">
                                <span>Gabriel</span>
                            </li>
                        </ul>
                        <div class="profile-actions">
                            <div id="flex-more">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <span class="header_icon">
        <img src="Imagens/bell-svgrepo-com 1.png" alt="Notifications">
    </span>
</header>
    <!-- Icon line after header -->
    <div id="icon-line">
        <span class="header_icon"><img src="imagens/image.png" alt=""></span>
        <span class="header_icon"><img src="imagens/image 3.png" alt=""></span>
        <span class="header_icon"><img src="imagens/image 5.png" alt=""></span>
        <span class="header_icon"><img src="imagens/image 6.png" alt=""></span>
    </div>

    <!-- Carousel -->
    <main id="main-grid">
        <div class="carousel-container">
            <!-- Container vazio: será preenchido pelo js (apicatalago.js) -->
            <div class="carousel-slide" id="main-carousel">
                <!-- posters serão inseridos aqui via JavaScript -->
            </div>

            <button id="prevBtn" class="carousel-button prev">&#10094;</button>
            <button id="nextBtn" class="carousel-button next">&#10095;</button>

            <div class="carousel-dots" id="main-carousel-dots">
                <!-- dots podem ser criadas dinamicamente -->
            </div>
        </div>
    </main>

    <div class="category-section">
        <h2 class="category-title">Comedy</h2>
        <div class="multi-carousel-container" id="comedy-section">
            <div class="carousel-list" data-section="comedy">
                <!-- itens preenchidos pelo js -->
            </div>
        </div>
    </div>

    <h2 class="category-title">Action</h2>
    <div class="multi-carousel-container" id="action-section">
        <div class="carousel-list" data-section="action">
            <!-- itens preenchidos pelo js -->
        </div>
    </div>

    <h2 class="category-title">Adventure</h2>
    <div class="multi-carousel-container" id="adventure-section">
        <div class="carousel-list" data-section="adventure">
            <!-- itens preenchidos pelo js -->
        </div>
    </div>
    
    <footer>
        <div class="footer-links">
            <ul>
                <li><a href="#">Audio description</a></li>
                <li><a href="#">Investor relations</a></li>
                <li><a href="#">Legal notices</a></li>
            </ul>
            <ul>
                <li><a href="#">Help center</a></li>
                <li><a href="#">Careers</a></li>
                <li><a href="#">Cookie preferences</a></li>
            </ul>
            <ul>
                <li><a href="#">Gift card</a></li>
                <li><a href="#">Terms of use</a></li>
                <li><a href="#">Corporate information</a></li>
            </ul>
            <ul>
                <li><a href="#">Press</a></li>
                <li><a href="#">Privacy</a></li>
                <li><a href="#">Contact us</a></li>
            </ul>
        </div>
        <div class="footer-copy">
            © 2025 Chimera, Inc.
        </div>
    </footer>

     <script src="js/script.js"></script>
    <script src="js/apicatalago.js"></script>

    <script>
      // Código do menu de perfil
      const profileIcon = document.querySelector('.profile-icon');
      const dropdownMenu = document.querySelector('.dropdown-menu');

      profileIcon.addEventListener('click', function(event) {
          event.stopPropagation();
          dropdownMenu.classList.toggle('active');
      });

      document.addEventListener('click', function() {
          if (dropdownMenu.classList.contains('active')) {
              dropdownMenu.classList.remove('active');
          }
      });

      dropdownMenu.addEventListener('click', function(event) {
          event.stopPropagation();
      });
    </script>

    <script>
      /*
        Busca filmes da API backend (/api/OmdbMovies) e popula:
         - #main-carousel
         - cada .carousel-list dentro de .multi-carousel-container
      */
      (() => {
        const API_BASE = window.API_BASE || 'http://localhost:5012';
        const FALLBACK_PLACEHOLDER = '';

        function proxyPosterUrl(posterUrl) {
          if (!posterUrl) return '';
          return `${API_BASE}/api/OmdbMovies/poster?url=${encodeURIComponent(posterUrl)}`;
        }

        async function fetchMovies() {
          try {
            const res = await fetch(`${API_BASE}/api/OmdbMovies`);
            if (!res.ok) throw new Error(`API error ${res.status}`);
            const movies = await res.json();
            return Array.isArray(movies) ? movies : [];
          } catch (err) {
            console.error('Erro ao buscar filmes da API:', err);
            return [];
          }
        }

        function shuffle(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
        }

        function extractUniquePosters(movies) {
          const set = new Set();
          const posters = [];
          for (const m of movies) {
            const p = (m && m.Poster) ? m.Poster.trim() : '';
            if (!p || p.toLowerCase() === 'n/a') continue;
            if (!set.has(p)) {
              set.add(p);
              posters.push({ poster: p, title: m.Title || '' });
            }
          }
          return posters;
        }

        function createImgElement(src, alt = '') {
          const img = document.createElement('img');
          img.src = src ? proxyPosterUrl(src) : FALLBACK_PLACEHOLDER;
          img.alt = alt;
          img.loading = 'lazy';
          return img;
        }

        function populateFromPosters(posters) {
          shuffle(posters);

          const mainCount = Math.min(6, posters.length);
          const sectionCount = 12;

          const working = posters.slice();
          const mainPosters = working.splice(0, mainCount);
          const comedyPosters = working.splice(0, sectionCount);
          const actionPosters = working.splice(0, sectionCount);
          const adventurePosters = working.splice(0, sectionCount);

          const mainSlide = document.querySelector('#main-carousel');
          if (mainSlide) {
            mainSlide.innerHTML = '';
            mainPosters.forEach(p => {
              const wrapper = document.createElement('div');
              wrapper.className = 'carousel-item main';
              wrapper.appendChild(createImgElement(p.poster, p.title));
              mainSlide.appendChild(wrapper);
            });
          }

          function fillSection(sectionId, listItems) {
            const container = document.querySelector(sectionId);
            if (!container) return;
            container.innerHTML = `<div class="carousel-list" data-section="${sectionId.replace('#','')}"></div>`;
            const list = container.querySelector('.carousel-list');
            listItems.forEach(p => {
              const item = document.createElement('div');
              item.className = 'carousel-item';
              item.appendChild(createImgElement(p.poster, p.title));
              list.appendChild(item);
            });
          }

          fillSection('#comedy-section', comedyPosters);
          fillSection('#action-section', actionPosters);
          fillSection('#adventure-section', adventurePosters);
        }

        function waitForImagesLoad(selectorList = ['#main-carousel img', '.carousel-list img'], timeout = 5000) {
          const selectors = selectorList.join(', ');
          const imgs = Array.from(document.querySelectorAll(selectors));
          if (imgs.length === 0) return Promise.resolve();
          const promises = imgs.map(img => new Promise(resolve => {
            if (img.complete) return resolve();
            const done = () => {
              img.removeEventListener('load', done);
              img.removeEventListener('error', done);
              resolve();
            };
            img.addEventListener('load', done);
            img.addEventListener('error', done);
          }));
          return Promise.race([Promise.all(promises), new Promise(resolve => setTimeout(resolve, timeout))]);
        }

        async function initCatalog() {
          const movies = await fetchMovies();
          const posters = extractUniquePosters(movies);
          if (posters.length === 0) console.warn('Nenhum poster válido retornado pela API.');
          populateFromPosters(posters);
          await waitForImagesLoad();
          window.__CHIMERA_MOVIES = movies;
          document.dispatchEvent(new CustomEvent('catalog:loaded', { detail: { movies } }));
        }

        document.addEventListener('DOMContentLoaded', initCatalog);
      })();
    </script>
</body>
</html>